{% extends 'base.html' %}

{% block title %}Book Your Appointment | MediTrust{% endblock %}

{% block content %}

<section class="booking-section">
    <div class="booking-container">
        <h2>Book: {{ service.name }}</h2>

        <form method="post" class="booking-form" id="booking-form">
            {% csrf_token %}
            <label>Name*</label>
            <input type="text" name="name" required>

            <label>Email*</label>
            <input type="email" name="email" required>

            <label>Phone*</label>
            <input type="text" name="phone" required>

            {% if service.category == 'lab_test' %}
            <label>Type of Test*</label>
            <select name="test_type" required>
                <option value="Blood Sugar">Blood Sugar</option>
                <option value="Cholesterol">Cholesterol</option>
                <option value="COVID-19">COVID-19</option>
                <option value="Urine Analysis">Urine Analysis</option>
            </select>
            {% endif %}

            <label>Select Doctor*</label>
            <select name="doctor" required>
                {% for doctor in doctors %}
                <option value="{{ doctor.id }}">{{ doctor.name }} ({{ doctor.specialty }})</option>
                {% endfor %}
            </select>

            <!-- ðŸ“… New Date Picker Field -->
            <label>Select Appointment Date*</label>
            <input type="text" id="appointment_date" name="appointment_date" placeholder="Choose a date" required
                readonly>

            <label>Hospital Address*</label>
            <input type="text" value="Sunrise Multispeciality Hospital, 42 MG Road, Sector 14, Gurugram, Haryana 122001"
                readonly>

            <input type="hidden" name="appointment_time" id="appointment_time">
            <p class="booking-price">Price: â‚¹{{ service.price }}</p>

            <a href="" class="booking-btn">Book & Pay</a>

        </form>

        <div id="calendar"></div>
    </div>
</section>

<!-- Razorpay Checkout -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("booking-form");
        const payButton = document.getElementById("rzp-button1");

        const options = {
            "key": "{{ razorpay_key }}",
            "amount": "{{ total|floatformat:0 }}00",
            "currency": "INR",
            "name": "MediTrust",
            "description": "Service Booking Payment",
            "order_id": "{{ razorpay_order_id }}",
            "handler": function (response) {
                // Add Razorpay payment details to the form
                const inputPaymentId = document.createElement("input");
                inputPaymentId.type = "hidden";
                inputPaymentId.name = "razorpay_payment_id";
                inputPaymentId.value = response.razorpay_payment_id;

                const inputOrderId = document.createElement("input");
                inputOrderId.type = "hidden";
                inputOrderId.name = "razorpay_order_id";
                inputOrderId.value = response.razorpay_order_id;

                form.appendChild(inputPaymentId);
                form.appendChild(inputOrderId);

                // Set form action to the success view
                form.action = "{% url 'payment_success' %}";
                form.method = "POST";
                form.submit();
            },
            "theme": {
                "color": "#28a745"
            }
        };

        const rzp1 = new Razorpay(options);

        payButton.addEventListener("click", function (e) {
            e.preventDefault();
            rzp1.open();
        });
    });
</script>


{% endblock %}